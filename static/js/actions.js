// Generated by CoffeeScript 1.6.3
var Action, ActionManager, BuildCityAction, BuildRoadAction, ClearForestAction, InitialPlacementAction, MoveAction, Overlay, RecruitUnitAction,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Action = (function() {
  function Action() {}

  Action.prototype.isValid = function() {
    return false;
  };

  Action.prototype.save = function() {
    var actionData;
    actionData = {
      kind: this.kind,
      col: this.col,
      row: this.row,
      move_path: this.movePath
    };
    return $.ajax({
      url: '/api/action/',
      method: 'POST',
      dataType: 'json',
      data: actionData,
      success: function(response) {},
      error: function(response) {
        return alert("Error saving move.  Please check your internet connection and try again: " + (JSON.stringify(response)));
      }
    });
  };

  return Action;

})();

InitialPlacementAction = (function(_super) {
  __extends(InitialPlacementAction, _super);

  function InitialPlacementAction(col, row) {
    this.col = col;
    this.row = row;
    this.kind = 'initial';
    this.name = 'Initial Placement';
  }

  InitialPlacementAction.prototype.isValid = function() {
    return TB.actions.count() < 8 && TB.board.isPassable(this.col, this.row) && TB.board.getUnitCount(this.col, this.row) === 0;
  };

  InitialPlacementAction.prototype.save = function() {
    return InitialPlacementAction.__super__.save.call(this);
  };

  InitialPlacementAction.prototype.draw = function() {};

  return InitialPlacementAction;

})(Action);

MoveAction = (function(_super) {
  __extends(MoveAction, _super);

  MoveAction.prototype.parseMovePath = function(movePath) {
    var coord, moves;
    moves = (function() {
      var _i, _len, _ref, _results;
      _ref = movePath.split('|');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        coord = _ref[_i];
        _results.push(coord.split(','));
      }
      return _results;
    })();
    return _.map(moves, function(coords) {
      return [parseInt(coords[0]), parseInt(coords[1])];
    });
  };

  function MoveAction(col, row, movePath) {
    this.col = col;
    this.row = row;
    this.movePath = movePath;
    this.kind = 'move';
    this.name = 'Move';
    if (this.movePath === void 0) {
      this.finished = false;
      this.moves = [];
    } else {
      this.finished = true;
      this.moves = this.parseMovePath(this.movePath);
    }
  }

  MoveAction.prototype.save = function() {
    this.finished = true;
    this.movePath = this.moves.join('|');
    return MoveAction.__super__.save.call(this);
  };

  MoveAction.prototype.isValid = function() {
    return this.moves.length > 0;
  };

  MoveAction.prototype.draw = function() {
    var centerCol, centerRow, graph, i, matrix, mouseColDiff, mouseRowDiff, next, nextCol, nextRow, node, path, prev, thisCol, thisRow, _i, _j, _len, _len1, _ref, _ref1, _results,
      _this = this;
    if (!this.finished) {
      centerCol = this.col;
      centerRow = this.row;
      mouseColDiff = TB.activeSquare.col - centerCol;
      mouseRowDiff = TB.activeSquare.row - centerRow;
      matrix = [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]];
      TB.actions.overlay.terrainCosts.iterateIntKeys(function(col, row, cost) {
        return matrix[6 + (col - centerCol)][6 + (row - centerRow)] = cost;
      });
      graph = new Graph(matrix);
      path = astar.search(graph.nodes, graph.nodes[6][6], graph.nodes[6 + mouseColDiff][6 + mouseRowDiff]);
      this.moves = [];
      for (_i = 0, _len = path.length; _i < _len; _i++) {
        node = path[_i];
        this.moves.push([node.x - 6 + centerCol, node.y - 6 + centerRow]);
      }
    }
    prev = 'start';
    next = 'end';
    thisCol = this.col;
    thisRow = this.row;
    _ref = this.moves;
    _results = [];
    for (i = _j = 0, _len1 = _ref.length; _j < _len1; i = ++_j) {
      _ref1 = _ref[i], nextCol = _ref1[0], nextRow = _ref1[1];
      if (nextCol > thisCol) {
        next = 'east';
      }
      if (nextCol < thisCol) {
        next = 'west';
      }
      if (nextRow < thisRow) {
        next = 'north';
      }
      if (nextRow > thisRow) {
        next = 'south';
      }
      this.drawArrow(thisCol, thisRow, prev, next);
      if (next === 'north') {
        prev = 'south';
      }
      if (next === 'south') {
        prev = 'north';
      }
      if (next === 'west') {
        prev = 'east';
      }
      if (next === 'east') {
        prev = 'west';
      }
      thisCol = nextCol;
      thisRow = nextRow;
      if (i === this.moves.length - 1) {
        _results.push(this.drawArrow(thisCol, thisRow, prev, 'end'));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  MoveAction.prototype.drawArrow = function(col, row, prev, next) {
    var screenX, screenY, tileX, tileY, _ref;
    screenX = TB.camera.worldColToScreenPosX(col);
    screenY = TB.camera.worldRowToScreenPosY(row);
    _ref = this.getArrowTileOffset(prev, next), tileX = _ref[0], tileY = _ref[1];
    return TB.ctx.drawImage(TB.images.othertilesImage, tileX, tileY, TB.gridSize, TB.gridSize, screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
  };

  MoveAction.prototype.getArrowTileOffset = function(dir1, dir2) {
    if (dir1 === 'west' && dir2 === 'end' || dir1 === 'end' && dir2 === 'west') {
      return [parseInt(TB.gridSize * 0), parseInt(TB.gridSize * 0)];
    }
    if (dir1 === 'south' && dir2 === 'end' || dir1 === 'end' && dir2 === 'south') {
      return [parseInt(TB.gridSize * 1), parseInt(TB.gridSize * 0)];
    }
    if (dir1 === 'east' && dir2 === 'end' || dir1 === 'end' && dir2 === 'east') {
      return [parseInt(TB.gridSize * 2), parseInt(TB.gridSize * 0)];
    }
    if (dir1 === 'north' && dir2 === 'end' || dir1 === 'end' && dir2 === 'north') {
      return [parseInt(TB.gridSize * 3), parseInt(TB.gridSize * 0)];
    }
    if (dir1 === 'south' && dir2 === 'east' || dir1 === 'east' && dir2 === 'south') {
      return [parseInt(TB.gridSize * 0), parseInt(TB.gridSize * 1)];
    }
    if (dir1 === 'north' && dir2 === 'east' || dir1 === 'east' && dir2 === 'north') {
      return [parseInt(TB.gridSize * 1), parseInt(TB.gridSize * 1)];
    }
    if (dir1 === 'west' && dir2 === 'north' || dir1 === 'north' && dir2 === 'west') {
      return [parseInt(TB.gridSize * 2), parseInt(TB.gridSize * 1)];
    }
    if (dir1 === 'west' && dir2 === 'south' || dir1 === 'south' && dir2 === 'west') {
      return [parseInt(TB.gridSize * 3), parseInt(TB.gridSize * 1)];
    }
    if (dir1 === 'start' && dir2 === 'east' || dir1 === 'east' && dir2 === 'start') {
      return [parseInt(TB.gridSize * 0), parseInt(TB.gridSize * 2)];
    }
    if (dir1 === 'start' && dir2 === 'north' || dir1 === 'north' && dir2 === 'start') {
      return [parseInt(TB.gridSize * 1), parseInt(TB.gridSize * 2)];
    }
    if (dir1 === 'start' && dir2 === 'west' || dir1 === 'west' && dir2 === 'start') {
      return [parseInt(TB.gridSize * 2), parseInt(TB.gridSize * 2)];
    }
    if (dir1 === 'start' && dir2 === 'south' || dir1 === 'south' && dir2 === 'start') {
      return [parseInt(TB.gridSize * 3), parseInt(TB.gridSize * 2)];
    }
    if (dir1 === 'start' && dir2 === 'end' || dir1 === 'end' && dir2 === 'start') {
      return [parseInt(TB.gridSize * 0), parseInt(TB.gridSize * 3)];
    }
    if (dir1 === 'west' && dir2 === 'east' || dir1 === 'east' && dir2 === 'west') {
      return [parseInt(TB.gridSize * 1), parseInt(TB.gridSize * 3)];
    }
    if (dir1 === 'north' && dir2 === 'south' || dir1 === 'south' && dir2 === 'north') {
      return [parseInt(TB.gridSize * 2), parseInt(TB.gridSize * 3)];
    }
  };

  return MoveAction;

})(Action);

RecruitUnitAction = (function(_super) {
  __extends(RecruitUnitAction, _super);

  function RecruitUnitAction(col, row) {
    this.col = col;
    this.row = row;
    this.kind = 'recruit';
    this.name = 'Recruit Unit';
  }

  RecruitUnitAction.prototype.isValid = function() {
    var action, unit, _i, _len, _ref;
    _ref = TB.actions.actions;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      action = _ref[_i];
      if (action.col === this.col && action.row === this.row && action.kind === 'recruit') {
        return false;
      }
    }
    unit = TB.board.units.get(this.col, this.row);
    if (unit === null || unit.ownerID !== TB.myAccount.id) {
      return false;
    }
    if (TB.myAccount.food < 2) {
      return false;
    }
    return true;
  };

  RecruitUnitAction.prototype.draw = function() {
    var screenX, screenY;
    screenX = TB.camera.worldColToScreenPosX(this.col);
    screenY = TB.camera.worldRowToScreenPosY(this.row);
    TB.ctx.save();
    TB.ctx.fillStyle = 'rgba(255,255,255,0.7)';
    TB.ctx.fillRect(screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
    return TB.ctx.restore();
  };

  return RecruitUnitAction;

})(Action);

BuildRoadAction = (function(_super) {
  __extends(BuildRoadAction, _super);

  function BuildRoadAction(col, row) {
    this.col = col;
    this.row = row;
    this.kind = 'road';
    this.name = 'Build Road';
  }

  BuildRoadAction.prototype.isValid = function() {
    var action, terrainType, _i, _len, _ref;
    _ref = TB.actions.actions;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      action = _ref[_i];
      if (action.col === this.col && action.row === this.row && action.kind === 'road') {
        return false;
      }
    }
    terrainType = TB.board.getTerrainType(this.col, this.row);
    if (terrainType !== 'plains') {
      return false;
    }
    if (TB.myAccount.wood < 10) {
      return false;
    }
    if (TB.actions.overlay.positions.get(this.col, this.row) === null) {
      return false;
    }
    return true;
  };

  BuildRoadAction.prototype.draw = function() {
    var screenX, screenY;
    screenX = TB.camera.worldColToScreenPosX(this.col);
    screenY = TB.camera.worldRowToScreenPosY(this.row);
    TB.ctx.save();
    TB.ctx.fillStyle = 'rgba(119,65,27,0.7)';
    TB.ctx.fillRect(screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
    return TB.ctx.restore();
  };

  return BuildRoadAction;

})(Action);

ClearForestAction = (function(_super) {
  __extends(ClearForestAction, _super);

  function ClearForestAction(col, row) {
    this.col = col;
    this.row = row;
    this.kind = 'tree';
    this.name = 'Clear Forest';
  }

  ClearForestAction.prototype.isValid = function() {
    var action, terrainType, _i, _len, _ref;
    _ref = TB.actions.actions;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      action = _ref[_i];
      if (action.col === this.col && action.row === this.row && action.kind === 'tree') {
        return false;
      }
    }
    terrainType = TB.board.getTerrainType(this.col, this.row);
    if (terrainType !== 'forest') {
      return false;
    }
    if (TB.actions.overlay.positions.get(this.col, this.row) === null) {
      return false;
    }
    return true;
  };

  ClearForestAction.prototype.draw = function() {
    var screenX, screenY;
    screenX = TB.camera.worldColToScreenPosX(this.col);
    screenY = TB.camera.worldRowToScreenPosY(this.row);
    TB.ctx.save();
    TB.ctx.fillStyle = 'rgba(0,100,0,0.7)';
    TB.ctx.fillRect(screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
    return TB.ctx.restore();
  };

  return ClearForestAction;

})(Action);

BuildCityAction = (function(_super) {
  __extends(BuildCityAction, _super);

  function BuildCityAction(col, row) {
    this.col = col;
    this.row = row;
    this.kind = 'city';
    this.name = 'Build city';
  }

  BuildCityAction.prototype.isValid = function() {
    return TB.myAccount.wood >= 10 && TB.board.isPassable(this.col, this.row);
  };

  BuildCityAction.prototype.draw = function() {};

  return BuildCityAction;

})(Action);

Overlay = (function() {
  function Overlay(unit, validationFn) {
    var i, lastSquares, possibleMovements, uncheckedSquares, _i,
      _this = this;
    this.positions = new util.Hash2D();
    this.terrainCosts = new util.Hash2D();
    possibleMovements = new util.Hash2D();
    lastSquares = new util.Hash2D();
    lastSquares.set(unit.col, unit.row, 0);
    uncheckedSquares = new util.Hash2D();
    for (i = _i = 1; _i <= 6; i = ++_i) {
      lastSquares.priorityPopAllIntKeys(function(col, row, dist) {
        var prevDist, thisCol, thisRow, traversalCost, _j, _len, _ref, _ref1, _results;
        _ref = [[col + 1, row], [col - 1, row], [col, row + 1], [col, row - 1]];
        _results = [];
        for (_j = 0, _len = _ref.length; _j < _len; _j++) {
          _ref1 = _ref[_j], thisCol = _ref1[0], thisRow = _ref1[1];
          if (possibleMovements.get(thisCol, thisRow) === null && TB.board.isPassable(thisCol, thisRow)) {
            traversalCost = TB.board.traversalCost(thisCol, thisRow);
            prevDist = uncheckedSquares.get(thisCol, thisRow, dist + traversalCost);
            if (prevDist === null || prevDist > dist + traversalCost) {
              _results.push(uncheckedSquares.set(thisCol, thisRow, dist + traversalCost));
            } else {
              _results.push(void 0);
            }
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      });
      possibleMovements.concat(uncheckedSquares);
      lastSquares = uncheckedSquares;
      uncheckedSquares = new util.Hash2D();
    }
    possibleMovements.iterateIntKeys(function(thisCol, thisRow, dist) {
      if (validationFn(thisCol, thisRow) && dist <= 6) {
        _this.positions.set(thisCol, thisRow, dist);
        return _this.terrainCosts.set(thisCol, thisRow, TB.board.traversalCost(thisCol, thisRow));
      }
    });
  }

  Overlay.prototype.draw = function(col, row) {
    var screenX, screenY;
    if (this.positions.get(col, row) !== null) {
      screenX = TB.camera.worldColToScreenPosX(col);
      screenY = TB.camera.worldRowToScreenPosY(row);
      TB.ctx.save();
      TB.ctx.fillStyle = 'rgba(255,255,255,0.3)';
      TB.ctx.fillRect(screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
      return TB.ctx.restore();
    }
  };

  return Overlay;

})();

ActionManager = (function() {
  ActionManager.MAPPINGS = {
    'initial': InitialPlacementAction,
    'move': MoveAction,
    'road': BuildRoadAction,
    'tree': ClearForestAction,
    'recruit': RecruitUnitAction
  };

  function ActionManager() {
    this.actions = [];
    this.overlay = null;
    this.moveInProgress = null;
  }

  ActionManager.prototype.createOverlay = function(unit, kind) {
    var fn;
    fn = kind === 'move' ? function(col, row) {
      return TB.board.isPassable(col, row);
    } : kind === 'tree' ? function(col, row) {
      return TB.board.getTerrainType(col, row) === 'forest';
    } : kind === 'road' ? function(col, row) {
      return TB.board.getTerrainType(col, row) === 'plains';
    } : void 0;
    if (fn) {
      return this.overlay = new Overlay(unit, fn);
    }
  };

  ActionManager.prototype.undo = function() {
    this.actions.pop();
    return $.ajax({
      url: '/api/undo/',
      method: 'POST',
      dataType: 'json',
      success: function(response) {},
      error: function(response) {
        return $('html').text("Error undoing move.  Please check your internet connection and try again: " + (JSON.stringify(response)));
      }
    });
  };

  ActionManager.prototype.beginMove = function(col, row) {
    return this.moveInProgress = new MoveAction(col, row);
  };

  ActionManager.prototype.loadFromJSON = function(json) {
    var actionData, action_class, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = json.length; _i < _len; _i++) {
      actionData = json[_i];
      action_class = ActionManager.MAPPINGS[actionData.kind];
      _results.push(this.actions.push(new action_class(actionData.col, actionData.row, actionData.movePath)));
    }
    return _results;
  };

  ActionManager.prototype.handleAction = function(kind, col, row) {
    var action;
    action = new ActionManager.MAPPINGS[kind](col, row);
    if (kind === 'move') {
      action.col = this.moveInProgress.col;
      action.row = this.moveInProgress.row;
      action.moves = this.moveInProgress.moves;
    }
    if (action.isValid()) {
      action.save();
      this.actions.push(action);
      return true;
    } else {
      this.moveInProgress = null;
      this.overlay = null;
      return false;
    }
  };

  ActionManager.prototype.count = function() {
    return this.actions.length;
  };

  ActionManager.prototype.draw = function() {
    var action, amount, col, i, initialPlacements, rgb, row, rowData, screenX, screenY, textX, textY, unitRadius, unitX, unitY, _i, _j, _len, _len1, _ref, _ref1, _ref2, _results;
    initialPlacements = new util.Hash2D();
    if (!TB.isInitialPlacement) {
      _ref = this.actions;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        action = _ref[i];
        action.draw();
      }
      if (this.moveInProgress) {
        return this.moveInProgress.draw();
      }
    } else {
      _ref1 = this.actions;
      for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
        action = _ref1[i];
        TB.fillOutlinedText(action.name, TB.camera.width - 16, 24 + i * 24 + 24);
        if (TB.isInitialPlacement) {
          initialPlacements.increment(action.col, action.row);
        }
      }
      _ref2 = initialPlacements.getRaw();
      _results = [];
      for (col in _ref2) {
        rowData = _ref2[col];
        _results.push((function() {
          var _results1;
          _results1 = [];
          for (row in rowData) {
            amount = rowData[row];
            screenX = TB.camera.worldToScreenPosX(col * TB.gridSize);
            screenY = TB.camera.worldToScreenPosY(row * TB.gridSize);
            unitX = screenX + TB.camera.zoomedGridSize / 2;
            unitY = screenY + TB.camera.zoomedGridSize / 2;
            unitRadius = TB.camera.zoomedUnitSize / 2;
            textX = unitX;
            textY = unitY - 3;
            TB.ctx.save();
            TB.ctx.beginPath();
            TB.ctx.fillStyle = 'rgba(0,0,0,0.5)';
            TB.ctx.arc(unitX, unitY, TB.camera.zoomedUnitSize / 2, 0, 2 * Math.PI);
            TB.ctx.fill();
            rgb = util.hexToRGB(TB.myAccount.color);
            TB.ctx.fillStyle = "rgba(" + rgb.r + "," + rgb.g + "," + rgb.b + ",0.5)";
            rgb.r = parseInt(rgb.r * 0.4);
            rgb.g = parseInt(rgb.g * 0.4);
            rgb.b = parseInt(rgb.b * 0.4);
            TB.ctx.strokeStyle = "rgba(" + rgb.r + "," + rgb.g + "," + rgb.b + ",0.5)";
            TB.ctx.lineWidth = 2;
            TB.ctx.beginPath();
            TB.ctx.arc(unitX, unitY - 8, TB.camera.zoomedUnitSize / 2, 0, 2 * Math.PI);
            TB.ctx.fill();
            TB.ctx.stroke();
            TB.ctx.restore();
            TB.ctx.textAlign = 'center';
            _results1.push(TB.fillOutlinedText(amount, textX, textY));
          }
          return _results1;
        })());
      }
      return _results;
    }
  };

  return ActionManager;

})();
