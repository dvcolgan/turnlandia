// Generated by CoffeeScript 1.6.3
var Board;

Board = (function() {
  function Board() {
    this.squares = new util.Hash2D();
    this.units = new util.Hash2D();
    this.unfinalizedSquares = new util.Hash2D();
    this.roadOverlay = new util.Hash2D();
    this.showRoadOverlay = false;
    this.clearForestOverlay = new util.Hash2D();
    this.showClearForestOverlay = false;
  }

  Board.prototype.getSubtiles = function(col, row) {
    var east, eastTerrain, north, northEast, northEastTerrain, northEastTile, northTerrain, northWest, northWestTerrain, northWestTile, otherCol, otherRow, otherUnfinalized, s, south, southEast, southEastTerrain, southEastTile, southTerrain, southWest, southWestTerrain, southWestTile, square, thisTerrain, west, westTerrain, _i, _len, _ref;
    thisTerrain = this.getTerrainType(col, row);
    northTerrain = this.getTerrainType(col, row - 1);
    southTerrain = this.getTerrainType(col, row + 1);
    eastTerrain = this.getTerrainType(col + 1, row);
    westTerrain = this.getTerrainType(col - 1, row);
    northEastTerrain = this.getTerrainType(col + 1, row - 1);
    northWestTerrain = this.getTerrainType(col - 1, row - 1);
    southEastTerrain = this.getTerrainType(col + 1, row + 1);
    southWestTerrain = this.getTerrainType(col - 1, row + 1);
    if (northTerrain === null) {
      this.unfinalizedSquares.push(col, row - 1, [col, row]);
    }
    if (southTerrain === null) {
      this.unfinalizedSquares.push(col, row + 1, [col, row]);
    }
    if (eastTerrain === null) {
      this.unfinalizedSquares.push(col + 1, row, [col, row]);
    }
    if (westTerrain === null) {
      this.unfinalizedSquares.push(col - 1, row, [col, row]);
    }
    if (northEastTerrain === null) {
      this.unfinalizedSquares.push(col + 1, row - 1, [col, row]);
    }
    if (northWestTerrain === null) {
      this.unfinalizedSquares.push(col - 1, row - 1, [col, row]);
    }
    if (southEastTerrain === null) {
      this.unfinalizedSquares.push(col + 1, row + 1, [col, row]);
    }
    if (southWestTerrain === null) {
      this.unfinalizedSquares.push(col - 1, row + 1, [col, row]);
    }
    north = northTerrain === thisTerrain;
    south = southTerrain === thisTerrain;
    east = eastTerrain === thisTerrain;
    west = westTerrain === thisTerrain;
    northEast = northEastTerrain === thisTerrain;
    northWest = northWestTerrain === thisTerrain;
    southEast = southEastTerrain === thisTerrain;
    southWest = southWestTerrain === thisTerrain;
    s = TB.gridSize / 2;
    if (west && northWest && north) {
      northWestTile = [s * 4, s * 0];
    }
    if (west && !northWest && north) {
      northWestTile = [s * 2, s * 2];
    }
    if (west && northWest && !north) {
      northWestTile = [s * 2, s * 0];
    }
    if (west && !northWest && !north) {
      northWestTile = [s * 2, s * 0];
    }
    if (!west && northWest && north) {
      northWestTile = [s * 0, s * 2];
    }
    if (!west && !northWest && north) {
      northWestTile = [s * 0, s * 2];
    }
    if (!west && northWest && !north) {
      northWestTile = [s * 0, s * 0];
    }
    if (!west && !northWest && !north) {
      northWestTile = [s * 0, s * 0];
    }
    if (east && northEast && north) {
      northEastTile = [s * 5, s * 0];
    }
    if (east && !northEast && north) {
      northEastTile = [s * 1, s * 2];
    }
    if (east && northEast && !north) {
      northEastTile = [s * 1, s * 0];
    }
    if (east && !northEast && !north) {
      northEastTile = [s * 1, s * 0];
    }
    if (!east && northEast && north) {
      northEastTile = [s * 3, s * 2];
    }
    if (!east && !northEast && north) {
      northEastTile = [s * 3, s * 2];
    }
    if (!east && northEast && !north) {
      northEastTile = [s * 3, s * 0];
    }
    if (!east && !northEast && !north) {
      northEastTile = [s * 3, s * 0];
    }
    if (west && southWest && south) {
      southWestTile = [s * 4, s * 1];
    }
    if (west && !southWest && south) {
      southWestTile = [s * 2, s * 1];
    }
    if (west && southWest && !south) {
      southWestTile = [s * 2, s * 3];
    }
    if (west && !southWest && !south) {
      southWestTile = [s * 2, s * 3];
    }
    if (!west && southWest && south) {
      southWestTile = [s * 0, s * 1];
    }
    if (!west && !southWest && south) {
      southWestTile = [s * 0, s * 1];
    }
    if (!west && southWest && !south) {
      southWestTile = [s * 0, s * 3];
    }
    if (!west && !southWest && !south) {
      southWestTile = [s * 0, s * 3];
    }
    if (east && southEast && south) {
      southEastTile = [s * 5, s * 1];
    }
    if (east && !southEast && south) {
      southEastTile = [s * 1, s * 1];
    }
    if (east && southEast && !south) {
      southEastTile = [s * 1, s * 3];
    }
    if (east && !southEast && !south) {
      southEastTile = [s * 1, s * 3];
    }
    if (!east && southEast && south) {
      southEastTile = [s * 3, s * 1];
    }
    if (!east && !southEast && south) {
      southEastTile = [s * 3, s * 1];
    }
    if (!east && southEast && !south) {
      southEastTile = [s * 3, s * 3];
    }
    if (!east && !southEast && !south) {
      southEastTile = [s * 3, s * 3];
    }
    otherUnfinalized = this.unfinalizedSquares.get(col, row);
    if (otherUnfinalized) {
      for (_i = 0, _len = otherUnfinalized.length; _i < _len; _i++) {
        _ref = otherUnfinalized[_i], otherCol = _ref[0], otherRow = _ref[1];
        square = this.squares.get(otherCol, otherRow);
        square.subTiles = this.getSubtiles(otherCol, otherRow);
      }
    }
    return [[northWestTile, northEastTile], [southWestTile, southEastTile]];
  };

  Board.prototype.addSquare = function(col, row, terrainType) {
    var newSquare;
    if (terrainType === 0) {
      terrainType = 'plains';
    }
    if (terrainType === 1) {
      terrainType = 'water';
    }
    if (terrainType === 2) {
      terrainType = 'mountains';
    }
    if (terrainType === 3) {
      terrainType = 'forest';
    }
    if (terrainType === 4) {
      terrainType = 'road';
    }
    if (terrainType === 5) {
      terrainType = 'city';
    }
    newSquare = new Square(col, row, terrainType);
    this.squares.set(col, row, newSquare);
    return newSquare.terrainType = this.getTerrainType(col, row);
  };

  Board.prototype.addUnit = function(col, row, ownerID, amount) {
    var i, unit, _i, _j, _results,
      _this = this;
    unit = new Unit(col, row, ownerID, amount);
    this.units.set(col, row, unit);
    this.roadOverlay.set(unit.col, unit.row, 0);
    for (i = _i = 1; _i <= 6; i = ++_i) {
      this.roadOverlay.iterateIntKeys(function(thisCol, thisRow, dist) {
        var east, north, south, west;
        if (dist === i - 1) {
          east = TB.board.isPassable(thisCol + 1, thisRow);
          west = TB.board.isPassable(thisCol - 1, thisRow);
          south = TB.board.isPassable(thisCol, thisRow + 1);
          north = TB.board.isPassable(thisCol, thisRow - 1);
          if (east) {
            _this.roadOverlay.set(thisCol + 1, thisRow, i);
          }
          if (west) {
            _this.roadOverlay.set(thisCol - 1, thisRow, i);
          }
          if (south) {
            _this.roadOverlay.set(thisCol, thisRow + 1, i);
          }
          if (north) {
            return _this.roadOverlay.set(thisCol, thisRow - 1, i);
          }
        }
      });
    }
    this.clearForestOverlay.set(unit.col, unit.row, 0);
    _results = [];
    for (i = _j = 1; _j <= 6; i = ++_j) {
      _results.push(this.clearForestOverlay.iterateIntKeys(function(thisCol, thisRow, dist) {
        var east, eastTerrain, north, northTerrain, south, southTerrain, west, westTerrain;
        if (dist === i - 1) {
          eastTerrain = TB.board.getTerrainType(thisCol + 1, thisRow);
          westTerrain = TB.board.getTerrainType(thisCol - 1, thisRow);
          southTerrain = TB.board.getTerrainType(thisCol, thisRow + 1);
          northTerrain = TB.board.getTerrainType(thisCol, thisRow - 1);
          east = eastTerrain === 'plains' || eastTerrain === 'forest';
          west = westTerrain === 'plains' || westTerrain === 'forest';
          south = southTerrain === 'plains' || southTerrain === 'forest';
          north = northTerrain === 'plains' || northTerrain === 'forest';
          if (east) {
            _this.clearForestOverlay.set(thisCol + 1, thisRow, i);
          }
          if (west) {
            _this.clearForestOverlay.set(thisCol - 1, thisRow, i);
          }
          if (south) {
            _this.clearForestOverlay.set(thisCol, thisRow + 1, i);
          }
          if (north) {
            return _this.clearForestOverlay.set(thisCol, thisRow - 1, i);
          }
        }
      }));
    }
    return _results;
  };

  Board.prototype.isPassable = function(col, row) {
    var terrainType;
    terrainType = this.getTerrainType(col, row);
    if (terrainType) {
      return terrainType !== 'water' && terrainType !== 'mountains';
    } else {
      return null;
    }
  };

  Board.prototype.getTerrainType = function(col, row) {
    var square;
    square = this.squares.get(col, row);
    if (square !== null) {
      return square.terrainType;
    } else {
      return null;
    }
  };

  Board.prototype.getUnitCount = function(col, row) {
    var unit;
    unit = this.units.get(col, row);
    if (unit !== null) {
      return unit.amount;
    } else {
      return 0;
    }
  };

  Board.prototype.traversalCost = function(col, row) {
    var terrainType;
    terrainType = this.getTerrainType(col, row);
    if (terrainType !== null) {
      if (terrainType === 'plains') {
        return 2;
      }
      if (terrainType === 'water') {
        return 0;
      }
      if (terrainType === 'mountains') {
        return 0;
      }
      if (terrainType === 'forest') {
        return 3;
      }
      if (terrainType === 'road') {
        return 1;
      }
      if (terrainType === 'city') {
        return 1;
      }
    } else {
      return 0;
    }
  };

  Board.prototype.draw = function() {
    var col, endCol, endRow, row, screenX, screenY, startCol, startRow, thisSquare, thisUnit, _i, _results;
    TB.ctx.textAlign = 'center';
    TB.ctx.fillStyle = '#148743';
    TB.ctx.fillRect(0, 0, TB.camera.width, TB.camera.height);
    TB.ctx.lineWidth = 1;
    startCol = Math.floor(TB.camera.x / TB.camera.zoomedGridSize);
    startRow = Math.floor(TB.camera.y / TB.camera.zoomedGridSize);
    endCol = startCol + Math.ceil(TB.camera.width / TB.camera.zoomedGridSize);
    endRow = startRow + Math.ceil(TB.camera.height / TB.camera.zoomedGridSize);
    _results = [];
    for (row = _i = startRow; startRow <= endRow ? _i <= endRow : _i >= endRow; row = startRow <= endRow ? ++_i : --_i) {
      _results.push((function() {
        var _j, _results1;
        _results1 = [];
        for (col = _j = startCol; startCol <= endCol ? _j <= endCol : _j >= endCol; col = startCol <= endCol ? ++_j : --_j) {
          thisSquare = this.squares.get(col, row);
          if (thisSquare) {
            thisSquare.draw();
          }
          thisUnit = this.units.get(col, row);
          if (thisUnit) {
            thisUnit.draw();
          }
          if (this.showRoadOverlay && this.roadOverlay.get(col, row) !== null && this.getTerrainType(col, row) === 'plains') {
            screenX = TB.camera.worldColToScreenPosX(col);
            screenY = TB.camera.worldRowToScreenPosY(row);
            TB.ctx.save();
            TB.ctx.fillStyle = 'rgba(119,65,27,0.3)';
            TB.ctx.fillRect(screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
            TB.ctx.restore();
          }
          if (this.showClearForestOverlay && this.clearForestOverlay.get(col, row) !== null && this.getTerrainType(col, row) === 'forest') {
            screenX = TB.camera.worldColToScreenPosX(col);
            screenY = TB.camera.worldRowToScreenPosY(row);
            TB.ctx.save();
            TB.ctx.fillStyle = 'rgba(0,255,0,0.3)';
            TB.ctx.fillRect(screenX, screenY, TB.camera.zoomedGridSize, TB.camera.zoomedGridSize);
            _results1.push(TB.ctx.restore());
          } else {
            _results1.push(void 0);
          }
        }
        return _results1;
      }).call(this));
    }
    return _results;
  };

  return Board;

})();
