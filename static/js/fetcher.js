// Generated by CoffeeScript 1.6.3
var DataFetcher;

DataFetcher = (function() {
  function DataFetcher() {
    this.loadingStates = new util.Hash2D();
  }

  DataFetcher.prototype.loadInitialData = function(callback) {
    var _this = this;
    return $.ajax({
      url: '/api/initial-load/',
      method: 'GET',
      dataType: 'json',
      success: function(data) {
        return callback(data);
      }
    });
  };

  DataFetcher.prototype.loadSectors = function(startSectorX, startSectorY, endSectorX, endSectorY, callback) {
    var sectorX, sectorY, _i, _results;
    _results = [];
    for (sectorX = _i = startSectorX; startSectorX <= endSectorX ? _i <= endSectorX : _i >= endSectorX; sectorX = startSectorX <= endSectorX ? ++_i : --_i) {
      _results.push((function() {
        var _j, _results1;
        _results1 = [];
        for (sectorY = _j = startSectorY; startSectorY <= endSectorY ? _j <= endSectorY : _j >= endSectorY; sectorY = startSectorY <= endSectorY ? ++_j : --_j) {
          if (this.loadingStates.get(sectorX, sectorY) === null) {
            this.loadingStates.set(sectorX, sectorY, false);
            _results1.push(this.loadSector(sectorX, sectorY, callback));
          } else {
            _results1.push(void 0);
          }
        }
        return _results1;
      }).call(this));
    }
    return _results;
  };

  DataFetcher.prototype.loadSector = function(sectorX, sectorY, callback) {
    var _this = this;
    return $.ajax({
      url: '/api/squares/' + (sectorX * TB.sectorSize) + '/' + (sectorY * TB.sectorSize) + '/' + TB.sectorSize + '/' + TB.sectorSize + '/',
      method: 'GET',
      dataType: 'text',
      success: function(sectorData) {
        _this.loadingStates.set(sectorX, sectorY, true);
        return $(window).trigger({
          type: 'sectorLoaded',
          sectorX: sectorX,
          sectorY: sectorY,
          sectorData: sectorData
        });
      }
    });
  };

  DataFetcher.prototype.loadSectorsOnScreen = function() {
    var endSectorX, endSectorY, sectorPixelSize, sectorsHigh, sectorsWide, startSectorX, startSectorY;
    sectorPixelSize = TB.sectorSize * TB.camera.zoomedGridSize;
    sectorsWide = Math.ceil(TB.camera.width / TB.camera.zoomedGridSize / TB.sectorSize) + 1;
    sectorsHigh = Math.ceil(TB.camera.height / TB.camera.zoomedGridSize / TB.sectorSize) + 1;
    startSectorX = Math.floor(TB.camera.x / sectorPixelSize);
    startSectorY = Math.floor(TB.camera.y / sectorPixelSize);
    endSectorX = Math.ceil((TB.camera.x + TB.camera.width) / sectorPixelSize);
    endSectorY = Math.ceil((TB.camera.y + TB.camera.height) / sectorPixelSize);
    return this.loadSectors(startSectorX, startSectorY, endSectorX, endSectorY);
  };

  return DataFetcher;

})();
