// Generated by CoffeeScript 1.6.3
var app, async, base64, express, getDjangoUserID, jpickle, request, sqlite3, square;

sqlite3 = require('sqlite3').verbose();

express = require('express');

request = require('request');

async = require('async');

base64 = require('base64');

jpickle = require('jpickle');

square = require('./square');

app = express();

app.use(express.cookieParser());

getDjangoUserID = function(req, callback) {
  var db;
  db = new sqlite3.Database('../../turnbased.sqlite');
  return db.get('SELECT * FROM django_session WHERE session_key = (?);', [req.cookies.sessionid], function(err, row) {
    var id, sessionData;
    console.log(row);
    sessionData = jpickle.loads(base64.decode(row.session_data).split(':')[1]);
    id = sessionData._auth_user_id;
    return callback(id);
  });
};

app.get('/api/squares/:startCol/:startRow/:endCol/:endRow/', function(req, res) {
  var endCol, endRow, startCol, startRow;
  startCol = parseInt(req.params.startCol);
  startRow = parseInt(req.params.startRow);
  endCol = parseInt(req.params.endCol);
  endRow = parseInt(req.params.endRow);
  return square.getRegion(startCol, startRow, endCol, endRow, function(data) {
    return res.send(data);
  });
});

app.get('/api/user/', function(req, res) {
  return getDjangoUserID(req, function(id) {
    return res.send({
      "id": id
    });
  });
});

app.get('/api/users/', function(req, res) {
  return res.send(JSON.stringify(square.getUsers()));
});

app.get('/api/couch/', function(req, res) {
  return request({
    url: 'http://127.0.0.1:5984/turnbased_dev/_design/get-all-squares/_view/getAllSquares',
    json: true
  }, function(error, response, body) {
    return res.send(body);
  });
});

app.listen(3000);

console.log('Listening on port 3000...');
